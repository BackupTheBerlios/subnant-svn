<?xml version="1.0" ?>
<!--
Copyright (C) 2005 Simon McKenna

Licensed under the GNU General Public License
http://www.gnu.org/copyleft/gpl.html

$Id$ 
-->
<project name="test" default="test">

    <target name="test" depends="init,init-repository,init-workingcopy">
        <if test="${property::exists('target')}">
            <call target="create-workingcopy" if="$({property::exists('target')==false) or ({property::exists('target')==true and string::contains('bugtraq'))}"/>
        </if>
        <ifnot test="${property::exists('target')}">
            <!-- Test bdb repository -->
            <if test="${no-bdb!='true'}">
                <echo level="Warning">Testing bdb repository and working copy...</echo>
                <echo file="${subnant-output}" message="Testing bdb repository and working copy..." append="true"/>
                <property name="repos"   value="test-repo-bdb"/>
                <property name="fs-type" value="bdb"/>
                <property name="wc"      value="${test-wc-bdb}"/>
                <call target="test-all"/>
            </if>
            <!-- Test fsfs repository -->
            <if test="${no-fsfs!='true'}">
                <echo level="Warning">Testing fsfs repository and working copy...</echo>
                <echo file="${subnant-output}" message="Testing fsfs repository and working copy..." append="true"/>
                <property name="repos"   value="test-repo-fsfs"/>
                <property name="fs-type" value="fsfs"/>
                <property name="wc"      value="${test-wc-fsfs}"/>
                <call target="test-all"/>
            </if>
        </ifnot>
        <delete dir="${test-root}" if="${directory::exists(test-root)}" unless="${keep=='true'}"/>
        <echo level="Warning">Test complete</echo>
        <echo file="${subnant-output}" message="Test complete" append="true"/>
    </target>

    <target name="test-all">
        <nant buildfile="create.build"  target="create"/>
        <call target="create-workingcopy"/>
        <nant buildfile="bugtraq.build" target="bugtraq"/>
        <call target="commit-workingcopy"/>
        <call target="search-log"/>
        <nant buildfile="verify.build"  target="verify"/>
        <nant buildfile="dump.build"    target="dump"/>
    </target>

    <target name="create-workingcopy">
        <delete dir="${wc}" if="${directory::exists(wc)}"/>
        <mkdir dir="${wc}" if="${directory::exists(test-root)}"/>
        <property name="uri" value='${path::to-uri(path::combine(svn-root,repos))}'/>
        <exec program="${svn}" workingdir="${wc}" failonerror="true">
            <arg value="checkout"/>
            <arg value="${uri}"/>
            <arg value="."/>
        </exec>
        <echo level="Warning">Checked out repository ${path::get-file-name(repos)} into ${wc}</echo>
    </target>

    <target name="commit-workingcopy">
        <exec program="${svn}" workingdir="${wc}" failonerror="true">
            <arg value="commit"/>
            <arg value="-m '${test-message}'"/>
        </exec>
        <echo level="Warning">Committed ${path::get-file-name(wc)} to ${path::get-file-name(repos)} with log ${test-message}</echo>
    </target>

    <target name="search-log">
        <exec program="${svnlook}" failonerror="true" output="${exec-output}" append="true">
            <arg value="log"/>
            <arg value="${path::combine(test-root,repos)}"/>
        </exec>
        <loadfile file="${exec-output}" property="test-output"/>
        <if test="${string::contains(test-output,test-message)}">
            <echo level="Warning">Found log ${test-message} in repository</echo>
        </if>
        <ifnot test="${string::contains(test-output,test-message)}">
            <fail>Did not find log ${test-message} in repository</fail>
        </ifnot>
    </target>

    <target name="init">
        <tstamp property="test-date" pattern="yyyyMMdd-HHmmss"/>
        <property name="keep"    value="false" unless="${property::exists('keep')    and string::to-lower(keep)=='true'}"/>
        <property name="no-bdb"  value="false" unless="${property::exists('no-bdb')  and string::to-lower(no-bdb)=='true'}"/>
        <property name="no-fsfs" value="false" unless="${property::exists('no-fsfs') and string::to-lower(no-fsfs)=='true'}"/>
        <property name="test-root" value="${path::combine(path::combine(path::get-temp-path(),'subnant-test'),test-date)}"/>
        <mkdir dir="${test-root}" unless="${directory::exists(test-root)}"/>
    </target>

    <target name="init-repository">
        <property name="svn-root"       value="${test-root}"/>
        <property name="test-dumps"     value="${path::combine(test-root,'repo-dumps')}"/>
        <mkdir dir="${test-dumps}" unless="${directory::exists(test-dumps)}"/>
        <property name="dump-root" value="${test-dumps}"/>
    </target>

    <target name="init-workingcopy">
        <property name="test-wc-bdb"  value="${path::combine(test-root,'wc-bdb')}"/>
        <property name="test-wc-fsfs" value="${path::combine(test-root,'wc-fsfs')}"/>
        <property name="test-message" value="${'message for test '+test-date}"/>
    </target>

    <target name="help">
        <echo level="Warning">
            <![CDATA[test: usage: subnant test [-D:options=<value>]

Call Subnant targets in a test environment

If no target is set, all main targets are tested

Options:
target          comma separated list of test targets
keep            set true to keep data created by test
no-bdb          set true to not test bdb repository
no-fsfs         set true to not test fsfs repository
sendemail       set true to email result

Examples:
subnant test
subnant test -D:target=create,verify,dump
subnant test -D:keep=true -D:no-bdb=true
            ]]>
        </echo>
    </target>
   
</project>