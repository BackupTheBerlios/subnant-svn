<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.1//EN" 
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>

    <title>Using Subversion properties for commit access control</title>

    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=ISO-8859-1" />
    <meta name="Keywords" content="Subversion,file-level,access-control,pre-commit,property,admin:commit-access,hook:commit-access" />
    <meta name="Description" content="Specification for using Subversion properties in conjunction with pre-commit hook for file-level commit access control" />

    <style type="text/css">
        dt { font-weight: bold; }
        .term { border-bottom: 1px dotted black; }
        .margin { margin-left: 1cm; }
    </style>

</head>

<body>

    <h3>Using Subversion properties for commit access control</h3>

    <p>Using <a href="http://svnbook.red-bean.com/en/1.1/ch07s02.html">properties</a>
        in partnership with the
        <a href="http://svnbook.red-bean.com/en/1.1/ch05s02.html#svn-ch-5-sect-2.1">pre-commit hook</a>
        and <a href="http://svnbook.red-bean.com/en/1.1/ch05s03.html#svn-ch-5-sect-3.1.1">svnlook</a>,
        we can provide a flexible, granular, visible and version controlled mechanism for commit
        access control independent of the repository access method.</p>

    <p>Two properties are used. One to administer commit rights and one to control who can commit.
        These properties can exist on individual files or directories, or on the parent directories
        of files or directories governed by access control. They do not have to co-exist at the same
        level in the repository path, however both properties must exist at the top level of the
        repository path you wish to control.</p>

    <p>Note: This approach provides file and directory level access control. If you only need to
        provide basic user-level access control, you might like to use this
        <a href="commit-allower.html">commit-allower</a> implementation, which is based on a
        similar concept.</p>

    <p>Caveat: This approach does not provide user authentication. The repository access method will
        still need to provide authentication to the server.</p>

    <dl>
        <dt><dfn>property: </dfn><span class="term">admin:commit-access</span></dt>
        <dd>
            <p>This property controls who can administer commit access. It contains a line delimited
                list of users permitted to modify both the <em>admin:commit-access</em> and
                <em>hook:commit-access</em> properties on the associated file or directory. In the
                case of directories, this permission cascades down to sub-directories and files
                within sub-directories.</p>

            <p>This property can also explicitly deny administration of commit access if any user is
                prefixed with an exclamation mark !.  This can be useful when a user has been granted
                commit administration rights higher up the repository path, and you wish to deny at
                a lower level down the repository path.</p>

            <p>e.g. To give users <var>admin1</var> and <var>user1</var> rights to control who is
                allowed to commit to any part of the repository, the <em>admin:commit-access</em>
                property is set to the following values on the repository root:</p>

            <p class="margin"><samp>admin1<br />user1</samp></p>

            <p>If you wanted to prevent <var>user1</var> from administering commit rights to a
                particular path in the repository, e.g. in the <samp>/admin</samp> directory,
                then <var>admin1</var> would set the following value to the
                <em>admin:commit-access</em> property on the <var>/admin</var> directory:</p>

            <p class="margin"><samp>!user1</samp></p>
        </dd>

        <dt><dfn>property: </dfn><span class="term">hook:commit-access</span></dt>
        <dd>
            <p>This property controls who has commit access.  It contains a line delimited list of
                users who are permitted to commit the file or directory of the property in question.
                For directories, this permission cascades down to sub-directories and files within
                sub-directories.</p>

            <p>This property can also explicitly deny commit access if any user is prefixed with
                an exclamation mark !.  This can be useful when a user has been granted commit
                rights higher up the repository path, and you wish to deny at a lower level down
                the repository path.</p>

            <p>e.g. To grant user <var>admin1</var> and <var>user1</var> commit rights to any part
                of the repository, <em>hook:commit-access</em> is set to the following values on
                the repository root:</p>

            <p class="margin"><samp>admin1<br />
                user1</samp></p>

            <p>If you wanted to prevent <var>user1</var> from committing in <samp>/admin</samp>,
                then <var>admin1</var> would set the following value to the
                <em>hook:commit-access</em> property on the <samp>/admin</samp> directory:</p>

            <p class="margin"><samp>!user1</samp></p>

		    <p>Note: A user defined in the <em>admin:commit-access</em> property must also exist
		        in at least one <em>hook:commit-access</em> property, so when first defining commit
		        access, which should be done at the top level you wish to control, it is necessary
		        to set both of these properties in a single commit.</p>
        </dd>

        <dt><dfn>hook: </dfn><span class="term">pre-commit</span></dt>
        <dd>
            <p>This hook validates user has commit access permission for each file, directory and
                property changed.</p>

			<p>The following steps are required:</p>

            <ol>
                <li>Build list of changes using <code>svnlook changed</code></li>
                <li>Build list of property changes using <code>svnlook proplist</code></li>
                <li>For each file and directory modified, search HEAD revision using
                    <code>svnlook propget</code>, then run the following tests against the
                    user performing the commit:
                    <ul>
                   	    <li>User exists, and is not prefixed with ! in
                   	        <em>admin:commit-access</em> if either the
                   	        <em>admin:commit-access</em> or <em>hook:commit-access</em>
                   	        properties have been changed</li>
                   	    <li>User exists, and is not prefixed with ! in
                   	        <em>hook:commit-access</em> property</li>
                   	</ul>
                </li>
                <li>If no rejection has been found, build consolidated list of directories paths
                    working backward to the root repository, remove any duplicates</li>
                <li>Repeat step 3., reversing up the directory path back to root, i.e. test the
                    lowest directories first and highest directories last</li>
            </ol>

			<p>The following conditions apply:</p>

            <ul>
                <li>Validation is halted and pre-commit rejected as soon as permission is
                    denied</li>
                <li>Validation is complete and per-commit passed once all modified files
                    and directories, and their higher directory paths have been tested</li>
            </ul>

            <br />
        </dd>
    </dl>

</body>

</html>
