<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.1//EN" 
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>

    <title>Using Subversion properties for commit access control</title>

    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=ISO-8859-1" />
    <meta name="Keywords" content="Subversion,access-control,pre-commit,start-commit,property" />
    <meta name="Description" content="Specification for using Subversion properties in conjunction with pre-commit or start-commit hooks for commit acesss control" />

    <style type="text/css">
        dt { font-weight: bold; }
        .term { border-bottom: 1px dotted black; }
        .margin { margin-left: 1cm; }
    </style>

</head>

<body>

    <h3>Using Subversion properties for commit access control</h3>

    <p>Using <a href="http://svnbook.red-bean.com/en/1.1/ch07s02.html">properties</a>
        in partnership with 
        <a href="http://svnbook.red-bean.com/en/1.1/ch05s02.html#svn-ch-5-sect-2.1">hooks</a>
        and <a href="http://svnbook.red-bean.com/en/1.1/ch05s03.html#svn-ch-5-sect-3.1.1">svnlook</a>,
        we can provide a flexible, granular, visible and version controlled mechanism for commit
        access control independent of the repository access method.</p>

    <p>Two properties are used. One to administer commit rights and one to control who can commit.
        These properties can exist on individual files or directories, or on the parent directories
        of files or directories governed by access control. They do not have to co-exist at the same
        level, however both should exist in the repository at the top level of the path you wish to
        control.</p>

    <p>Caveat: This approach does not provide user authentication. The repository access method will
        still need to provide authentication to the server.</p>

    <dl>
        <dt><dfn>property: </dfn><span class="term">admin:commit-access</span></dt>
        <dd>
            <p>This property controls who can administer commit access. It contains a line delimited
                list of users permitted to modify both the <em>admin:commit-access</em> and
                <em>hook:commit-access</em> properties on the associated file or directory. In the
                case of directories, this permission cascades down to sub-directories and files
                within sub-directories.</p>

            <p>This property can also explicitly deny administration of commit access if any user is
                prefixed with an exclamation mark !.  This can be useful when a user has been granted
                access rights higher up the repository path and you wish to deny at a lower level
                down the path.</p>

            <p>e.g. To give users <var>admin1</var> and <var>user1</var> rights to control who is
                allowed to commit to any part of the repository, the <em>admin:commit-access</em>
                property is set to the following values on the repository root:</p>

            <p class="margin"><samp>admin1<br />user1</samp></p>

            <p>If you wanted to prevent <var>user1</var> from administering commit rights to a
                particular path in the repository, e.g. in the <samp>/admin-only</samp> directory,
                then <var>admin1</var> would set the following value to the
                <em>hook:propchange-access</em> property on the <var>/admin-only</var> directory:</p>

            <p class="margin"><samp>!user1</samp></p>
        </dd>

        <dt><dfn>property: </dfn><span class="term">hook:commit-access</span></dt>
        <dd>
            <p>This property controls who has commit access.  It contains a line delimited list of
                users who are permitted to commit the file or directory of the property in question.
                For directories, this permission cascades down to sub-directories and files within
                sub-directories.</p>

            <p>This property can also explicitly deny commit access if any user is prefixed with
                an exclamation mark !.</p>

            <p>e.g. To grant user <var>admin1</var> and <var>user1</var> commit rights to any part
                of the repository, <em>hook:commit-access</em> is set to the following values on
                the repository root:</p>

            <p class="margin"><samp>admin1<br />
                user1</samp></p>

            <p>If you wanted to prevent <var>user1</var> from committing in
                <samp>/admin-only</samp>, then <var>admin1</var> would set the following
                value to the <em>hook:commit-access</em> property on the
                <samp>/admin-only</samp> directory:</p>

            <p class="margin"><samp>!user1</samp></p>
        </dd>

        <dt><dfn>hook: </dfn><span class="term">pre-commit</span></dt>
        <dd>
            <p>This hook ensures that for files and directories changed in the transaction, the user
               performing the commit has the appropriate rights for each file, property or directory
               associated with them.</p>

            <ol>
                <li>Build list of properties changed using <code>svnlook proplist</code></li>
                <li>Build list of files and directories changed using
                   <code>svnlook changed</code></li>
                <li>For each file and directory modified, the HEAD revision is searched using
                   <code>svnlook propget</code> for the <em>hook:commit-access</em> property,
                   and if found, validated against the user performing the commit. If it is a
                   property being modified (as determined by step 1.), and that property is
                   either the <em>admin:commit-access</em> or <em>hook:commit-access</em>
                   property, then a validation is made against the <em>hook:commit-access</em>
                   property</li>
                <li>Search is halted as soon as permission denied property is found</li>
                <li>Search is complete once all modified files and directories, and their parent
                   directory paths have been validated</li>
            </ol>

            <p>All steps must be successfully executed before commit access is granted.</p>
        </dd>

        <dt><dfn>hook: </dfn><span class="term">start-commit</span></dt>
        <dd>
            <p>This hook script searches HEAD revision for the <em>hook:commit-access</em>
                property on the repository root, and if found, verifies user is permitted
                to commit.  This enables basic commit access control for each user.</p>
        </dd>
    </dl>

</body>

</html>
